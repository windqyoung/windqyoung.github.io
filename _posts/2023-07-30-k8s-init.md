---
title: k8s服务初始化记录
---


1. 修改 containerd 默认设置

    `containerd config default > /etc/containerd/config.toml`

    修改 `SystemdCgroup = true`

    修改 `sandbox_image = "registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9"`

    版本根据 `kubeadm config images list` 的值而定


2. 执行k8s初始化, IP根据下一步中的配置文件中的`net-conf.json.NetWork`而定 [IP说明](https://github.com/flannel-io/flannel/blob/master/Documentation/kubernetes.md) [flannel仓库](https://github.com/flannel-io/flannel)

    下面命令使用的镜像, 可以自己下载 


    ```
    for x in docker.io/flannel/flannel:v0.22.1 docker.io/flannel/flannel-cni-plugin:v1.2.0; do
        echo $x
        docker pull $x
        docker save $x | ctr -n k8s.io image import -
    done
    ```

    `kubeadm init --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers --pod-network-cidr 10.244.0.0/16`

3. 安装网络插件

    `kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml`

    如果多节点集群网络不通, 修改网络插件配置文件如下: 增加参数 `--iface=enp0s8`

    ```
     containers:
      - args:
        - --ip-masq
        - --kube-subnet-mgr
        - --iface=enp0s8
        command:
        - /opt/bin/flanneld
    ```

4. 根据上一步命令的结果, 设置配置文件

5. 查看结果 `kubectl get nodes`



