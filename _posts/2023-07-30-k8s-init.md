---
title: k8s服务初始化记录
---


1. 修改 containerd 默认设置

    `containerd config default > /etc/containerd/config.toml`

    修改 `sandbox_image = "registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9"`
    
    修改 `SystemdCgroup = true`

2. 下载 containerd cni [网络插件](https://github.com/containernetworking/plugins/releases) [文档](https://github.com/containernetworking/cni)

    解压到 `/opt/cni/` 目录

    修改文件 `/etc/cni/net.d/*`
    ```
    mkdir -p /etc/cni/net.d
cat >/etc/cni/net.d/10-mynet.conf <<EOF
{
    "cniVersion": "0.2.0",
    "name": "mynet",
    "type": "bridge",
    "bridge": "cni0",
    "isGateway": true,
    "ipMasq": true,
    "ipam": {
        "type": "host-local",
        "subnet": "10.22.0.0/16",
        "routes": [
            { "dst": "0.0.0.0/0" }
        ]
    }
}
EOF
cat >/etc/cni/net.d/99-loopback.conf <<EOF
{
    "cniVersion": "0.2.0",
    "name": "lo",
    "type": "loopback"
}
EOF
    ```
3. 修改内核参数

```
modprobe br_netfilter
echo "net.bridge.bridge-nf-call-iptables=1" >> /etc/sysctl.conf
echo "net.bridge.bridge-nf-call-ip6tables=1" >> /etc/sysctl.conf

sysctl -p /etc/sysctl.conf
```
3. 执行k8s初始化

    `kubeadm init --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers`

4. 根据上一步命令的结果, 设置配置文件

5. 查看结果 `kubectl get nodes`



